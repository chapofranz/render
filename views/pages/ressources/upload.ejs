<div class="container-flex main-container" id="upload">
    <div class="container-fluid headline">
        <h1>
            Upload
        </h1>
    </div>
    <% if (typeof message !=='undefined' && message) { %>
        <div class="container-fluid text-center message <%= messageClass %>">
            <p>
                <%= message %>
            </p>
        </div>
        <% } %>
            <div class="wrapper-grid">
                <form class="wrapper upload" id="upload-form" action="/upload/new" method="post"
                    enctype="multipart/form-data">
                    <div class="nested">
                        <label for="name" id="label">Name</label>
                        <input id="Dateiname-input" type="text" v-model="name" :class="{'is-invalid': invalidName}"
                            placeholder="Dateiname" name="name" class="upload-form" required>
                        <div class="invalid-feedback" v-if="invalidName">Max 15 Zeichen, _ - Buchstaben und Zahlen!
                        </div>
                    </div>
                    <div class="nested">
                        <label for="kategorie" id="label">Kategorie</label>
                        <select id="Kategorie-selector" name="kategorie" class="nested upload-form" required>
                            <option value="Bitte auswählen">Bitte auswählen</option>
                            <option value="Skript">Skript</option>
                            <option value="Anleitung">Anleitung</option>
                        </select>
                    </div>
                    <div class="nested">
                        <label for="studiengang" id="label">Studiengang</label>
                        <select name="studiengang" id="studiengang" class="upload-form" required
                            onchange="updateModule(this.value)">
                            <option value="Studiengang wählen">Wählen einen Studiengang aus</option>
                            <% studiengaenge.forEach(function(studiengang) { %>
                                <option value="<%= studiengang.id %>">
                                    <%= studiengang.name %> (<%= studiengang.id %>)
                                </option>
                                <% }); %>
                        </select>
                    </div>
                    <div class="nested">
                        <label for="modul" id="label">Modul</label>
                        <select name="modul" id="modul" class="upload-form" required>
                            <option value="Modul">Wählen ein Modul aus</option>
                            <!-- Module options werden hier reingeladen! -->
                        </select>
                    </div>
                    <div class="nested">
                        <label for="beschreibung" id="label">Beschreibung</label>
                        <input id="Beschreibung-input " type="text" placeholder="Beschreibung des Inhalts"
                            name="beschreibung" class="upload-form" required>
                    </div>
                    <div class="nested">
                        <label for="author" id="label">Author</label>
                        <input id="Author-input" type="text" placeholder="Dein Name (optional)" name="author"
                            class="upload-form" required>
                    </div>
                    <div class="nested">
                        <label for="pfad" id="label">Dokument</label>
                        <input id="Dokument-selection" type="file" placeholder="Datei aus Verzeichniss wählen"
                            name="data" required>
                    </div>
                    <div class="nested">
                        <label for="upload-button" id="label">Jetzt hochladen</label>
                        <button type="submit" class="btn btn-primary" id="upload-button">Upload</button>
                    </div>

                </form>
            </div>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                name: '',
                invalidName: false,
            }


        },
        methods: {
            validName: function (name) {
                let re = /^[0-9a-zA-Z\s_-]{1,15}$/;;
                return re.test(name);

            }

        },

        watch: {
            name: function (newName) {
                this.invalidName = !this.validName(newName);
            }

        }


    }).mount("#upload");

    function updateModule(studiengangId) {
        // Fetch modules für den ausgewählen studiengang
        fetch('/studiengang/' + studiengangId + '/module')
            .then(response => response.json())
            .then(module => {
                
                const modulDropdown = document.getElementById('modul');

              
                modulDropdown.innerHTML = '';

                // Modul optionen hinzufügen! 
                module.forEach(modul => {
                    const option = document.createElement('option');
                    option.value = modul.id;
                    option.text = modul.name + ' (' + modul.id + ')';
                    modulDropdown.add(option);
                });
            });
    }
</script>